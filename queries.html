<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Queries - The Aerology Debugger</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="prep.html"><strong aria-hidden="true">3.</strong> Debugging Prep</a></li><li class="chapter-item expanded "><a href="conf-seg-dts.html"><strong aria-hidden="true">4.</strong> Config, Segments, Device Tree</a></li><li class="chapter-item expanded "><a href="stacks.html"><strong aria-hidden="true">5.</strong> Stacks</a></li><li class="chapter-item expanded "><a href="queries.html" class="active"><strong aria-hidden="true">6.</strong> Queries</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Aerology Debugger</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="queries"><a class="header" href="#queries">Queries</a></h1>
<p>Aerology's <code>query</code> subcommand is easily it's most general purpse tool.
It provides a means to inspect arbitrary objects (e.g. structs, unions, etc.)
in a C-style fromat or a hexdump.</p>
<h2 id="syntax"><a class="header" href="#syntax">Syntax</a></h2>
<p>The syntax of a query is inspired by <code>jq</code>, and many of the operators are postfix.
An Aerology query is structured as a global, with optional postfix operators,
followed by zero or more <code>=&gt;</code> separated &quot;filters&quot;.</p>
<h3 id="global"><a class="header" href="#global">Global</a></h3>
<p>Unlike <code>jq</code>, the initial value is provided by global optionally prefixed with a
executable namespace.
For example, to get the zephyr kernel struct, either of the following queries
produce the same result:</p>
<pre><code>_kernel
</code></pre>
<pre><code>zephyr::kernel
</code></pre>
<p>Executing a query with just the global prints the whole structure C-style:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0 zephyr::_kernel
21001ec0: (struct z_kernel) {
    .cpus = {
        (struct _cpu) {
            .nested = (uint32_t) 0 /*0x0*/,
            .irq_stack = (char *) 553664832 /*0x21004140*/,
            .current = (struct k_thread *) 553651864 /*0x21000e98*/,
            .idle_thread = (struct k_thread *) 553651680 /*0x21000de0*/,
            .slice_ticks = (int) 0,
            .id = (uint8_t) 0 /*0x0*/,
            /* .arch is Missing */
        },
    },
    .ready_q = (struct _ready_q) {
        .cache = (struct k_thread *) 553651864 /*0x21000e98*/,
        .runq = (sys_dlist_t) {
            .head = (struct _dnode *) 553651864 /*0x21000e98*/,
            .next = (struct _dnode *) 553651864 /*0x21000e98*/,
            .tail = (struct _dnode *) 553650440 /*0x21000908*/,
            .prev = (struct _dnode *) 553650440 /*0x21000908*/,
        },
    },
    .threads = (struct k_thread *) 553652056 /*0x21000f58*/,
}
</code></pre>
<h3 id="postfix-operators"><a class="header" href="#postfix-operators">Postfix Operators</a></h3>
<p>Once a global is selected, you may follow members with postfix operators.
All postfix operators expect a type class (struct, array, pointer, etc.), and
will error when the type at that step of the query is of a different class.</p>
<p>The operators are:</p>
<ul>
<li><code>.&lt;struct-member&gt;</code> to traverse a struct into a member named
&quot;struct-member&quot;. This will derefrence pointers to structures
before atempting to move to a member if the current type is a 
pointer to a structure. This will error when the struct does
not contain the required member.</li>
<li><code>[&lt;number&gt;]</code> will select array member with index &quot;number&quot;. Similar
to the struct member operation, this will dereference pointers to
arrays before atempting to select the member. This will error if
the index is out of bounds, or the array has no size.</li>
<li><code>[]</code> will select all array members, treating the remainder of the
query as a query over all members of the array. This will error if
the array has no size.</li>
<li><code>.*</code> postfix derefrence operator. This will derefrence a pointer.</li>
</ul>
<h4 id="struct-member"><a class="header" href="#struct-member">Struct Member</a></h4>
<p>Continuing with the Zephyr kernel structure, we may select the head of the
threads linked list as follows:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0  zephyr::_kernel.threads
21001ee4: (struct k_thread *) 553652056 /*0x21000f58*/
</code></pre>
<p>If we were to have a typo, we would get an error such as:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0  zephyr::_kernel.thread
Error:
  × member not found &quot;thread&quot;
   ┌─[command-line:1:1]
 1 │ zephyr::_kernel.thread
   ·                 ───┬──
   ·                    └── missing
   └────
  help: consider replacing with &quot;cpus&quot;, &quot;ready_q&quot; or &quot;threads&quot; instead
</code></pre>
<p>If we try to select a member of something that's not a struct, such as the cpu
array, we get a type error such as:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0  zephyr::_kernel.cpus.nested
Error:
  × type mismatch
   ┌─[command-line:1:1]
 1 │ zephyr::_kernel.cpus.nested
   ·                      ───┬──
   ·                         └── expected struct or union found struct _cpu[1]
   └────
</code></pre>
<p>Members may be selected through poiters to structures, without an intevening 
dereference operator. 
For exmple, if we wanted to select the <code>arch</code> member of the thread struct at
the head of the threads linked list, we may use the following query:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0  zephyr::_kernel.threads
21001ee4: (struct k_thread *) 553652056 /*0x21000f58*/
$ aerology query dhcpv4_client.core.0  zephyr::_kernel.threads.arch
21001004: (struct _thread_arch) {
    .basepri = (uint32_t) 0 /*0x0*/,
    .swap_return_value = (uint32_t) 4294967285 /*0xfffffff5*/,
    .mode = (uint32_t) 48128 /*0xbc00*/,
    .mode_bits = (uint8_t) 0 /*0x0*/,
    .mode_exc_return = (uint8_t) 188 /*0xbc*/,
    .mode_reserved2 = (uint16_t) 0 /*0x0*/,
}
</code></pre>
<p>Note that above the type of <code>zephyr::_kernel.threads</code> is a <code>struct k_thread *</code>,
but we used it as if it were a <code>struct k_thread</code>.</p>
<h3 id="array-index"><a class="header" href="#array-index">Array Index</a></h3>
<p>Selecting an index in an array works similar to selecting a struct member.
For example if we wanted to select the first entry (index 0) of the Zephyr
kernel's cpu array we may:</p>
<pre><code>$ aerology query dhcpv4_client.core.0  zephyr::_kernel.cpus[0]
21001ec0: (struct _cpu) {
    .nested = (uint32_t) 0 /*0x0*/,
    .irq_stack = (char *) 553664832 /*0x21004140*/,
    .current = (struct k_thread *) 553651864 /*0x21000e98*/,
    .idle_thread = (struct k_thread *) 553651680 /*0x21000de0*/,
    .slice_ticks = (int) 0,
    .id = (uint8_t) 0 /*0x0*/,
    /* .arch is Missing */
}
</code></pre>
<p>However, if we index past the end of the array, we get an error:</p>
<pre><code>$ aerology query dhcpv4_client.core.0  zephyr::_kernel.cpus[11110]
Error:
  × Array index out of bounds
   ┌─[command-line:1:1]
 1 │ zephyr::_kernel.cpus[11110]
   ·                     ───────
   └────
  help: This array has a size of 1
</code></pre>
<p>Further if we try to index something other than an array, we get a type error
such as:</p>
<pre><code>$ aerology query dhcpv4_client.core.0  zephyr::_kernel[6]
Error:
  × type mismatch
   ┌─[command-line:1:1]
 1 │ zephyr::_kernel[6]
   ·                ─┬─
   ·                 └── expected array found struct z_kernel
   └────
</code></pre>
<h3 id="whole-array"><a class="header" href="#whole-array">Whole Array</a></h3>
<p>You may select a whole array by omitting an array index. For example, we may
print the value of the char array that makes up a thread's name with the query:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0  zephyr::_kernel.threads.name[]
21000fd0: (char) 115 /*0x73*/
21000fd1: (char) 121 /*0x79*/
21000fd2: (char) 115 /*0x73*/
21000fd3: (char) 119 /*0x77*/
21000fd4: (char) 111 /*0x6f*/
21000fd5: (char) 114 /*0x72*/
21000fd6: (char) 107 /*0x6b*/
21000fd7: (char) 113 /*0x71*/
21000fd8: (char) 0 /*0x0*/
21000fd9: (char) 0 /*0x0*/
21000fda: (char) 0 /*0x0*/
21000fdb: (char) 0 /*0x0*/
21000fdc: (char) 0 /*0x0*/
21000fdd: (char) 0 /*0x0*/
21000fde: (char) 0 /*0x0*/
21000fdf: (char) 0 /*0x0*/
21000fe0: (char) 0 /*0x0*/
21000fe1: (char) 0 /*0x0*/
21000fe2: (char) 0 /*0x0*/
21000fe3: (char) 0 /*0x0*/
21000fe4: (char) 0 /*0x0*/
21000fe5: (char) 0 /*0x0*/
21000fe6: (char) 0 /*0x0*/
21000fe7: (char) 0 /*0x0*/
21000fe8: (char) 0 /*0x0*/
21000fe9: (char) 0 /*0x0*/
21000fea: (char) 0 /*0x0*/
21000feb: (char) 0 /*0x0*/
21000fec: (char) 0 /*0x0*/
21000fed: (char) 0 /*0x0*/
21000fee: (char) 0 /*0x0*/
21000fef: (char) 0 /*0x0*/
</code></pre>
<p>This query is a tad silly, as aerology is capable of printing strings directly:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0  zephyr::_kernel.threads.name
21000fd0: (char[32]) &quot;sysworkq&quot;
</code></pre>
<h2 id="filters"><a class="header" href="#filters">Filters</a></h2>
<p>At the moment, 3 filters are supported:</p>
<ul>
<li>Postfix operators.</li>
<li>Reading a linked list with <code>llnodes</code></li>
<li>Creating a bactrace with <code>bt</code></li>
</ul>
<h3 id="postfix-operators-1"><a class="header" href="#postfix-operators-1">Postfix operators</a></h3>
<p>Postfix operators may be used as a filter by themselves.
Using an example from the prior section, we may query the name of the head of
the thread list including the filter separator <code>=&gt;</code> in a few more places.</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0  'zephyr::_kernel =&gt; .threads.name'
21000fd0: (char[32]) &quot;sysworkq&quot;

$ aerology  query dhcpv4_client.core.0  'zephyr::_kernel =&gt; .threads =&gt; .name'
21000fd0: (char[32]) &quot;sysworkq&quot;

$ aerology query dhcpv4_client.core.0  'zephyr::_kernel.threads =&gt; .name'
o21000fd0: (char[32]) &quot;sysworkq&quot;
</code></pre>
<p>As may be seen in the exmaple above, these produce the same result.</p>
<h3 id="linked-list-nodes"><a class="header" href="#linked-list-nodes">Linked List Nodes</a></h3>
<p>An important filter in Aerology is the linked list nodes reader.
It's invoked <code>llnodes &lt;postfix-member&gt;</code>.
For example, to get the names of all of the threads in the system, we may
use the following query:</p>
<pre><code class="language-bash">$ aerology query dhcpv4_client.core.0 'zephyr::_kernel.threads =&gt; llnodes .next_thread =&gt; .name'
21000e58: (char[32]) &quot;idle 00&quot;
210008c8: (char[32]) &quot;logging&quot;
21000f10: (char[32]) &quot;main&quot;
21000980: (char[32]) &quot;shell_uart&quot;
21000fd0: (char[32]) &quot;sysworkq&quot;
</code></pre>
<h3 id="backtrace"><a class="header" href="#backtrace">Backtrace</a></h3>
<p>Another interesting Aerology filter is the backtrace filter.
This filter has a more complex syntax:</p>
<pre><code>bt &lt;reg-name&gt;=&lt;postfix-member&gt;
</code></pre>
<p>This filter backtraces after populating the initial register state as
described by its arguments.</p>
<p>For example, we can take a backtrace of every thread in TFM with the
following query:</p>
<pre><code>$ aerology query dhcpv4_client.core.0 'tfm_s::partition_listhead =&gt; llnodes .next =&gt; bt pc=.ctx_ctrl.exc_ret psp_s=.ctx_ctrl.sp'
3000bfcc:
  ╞═ Exception Handler Called
  ├─ 11008e70 in tfm_arch_trigger_pendsv
  ├─ 11007ee3 in spm_interface_thread_dispatcher
  └─ 11021187 in psa_interface_unified_abi
3000c014:
  ╞═ Exception Handler Called
  ├─ 11008e70 in tfm_arch_trigger_pendsv
  ├─ 11007ee3 in spm_interface_thread_dispatcher
  └─ 11021187 in psa_interface_unified_abi
3000c05c:
  ╞═ Exception Handler Called
  ├─ 11008e70 in tfm_arch_trigger_pendsv
  ├─ 11007ee3 in spm_interface_thread_dispatcher
  └─ 11021187 in psa_interface_unified_abi
3000c0a4:
  ╞═ Exception Handler Called
  ├─ 11008e70 in tfm_arch_trigger_pendsv
  ├─ 11007ee3 in spm_interface_thread_dispatcher
  └─ 11021187 in psa_interface_unified_abi
3000c0ec:
  ╞═ Exception Handler Called
  ├─ 11008e70 in tfm_arch_trigger_pendsv
  ├─ 11007ee3 in spm_interface_thread_dispatcher
  └─ 11021187 in psa_interface_unified_abi
3000c134:
  ╞═ Exception Handler Called
  └─ 11008c85 in tfm_nspm_thread_entry
3000c6e4:
  ╞═ Exception Handler Called
  └─ 11008ca5 in tfm_idle_thread
</code></pre>
<blockquote>
<p>Note: Zephyr does not store the entire exception payload, so without bitwise
operations, we cannot construct a valid value for the pc.</p>
</blockquote>
<blockquote>
<p>Note: we place the exception payload in pc, not the lr.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="stacks.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="stacks.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
